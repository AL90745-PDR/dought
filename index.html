<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Login Portal with EmailJS</title>
  <style>
    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      margin: 0;
      background: linear-gradient(to right, #83a4d4, #b6fbff);
      color: #333;
    }
    .container {
      max-width: 400px;
      margin: 50px auto;
      padding: 20px;
      background: #fff;
      border-radius: 12px;
      box-shadow: 0 4px 8px rgba(0,0,0,0.1);
    }
    .hidden { display: none; }
    .sidebar {
      width: 220px;
      float: left;
      background: #2c3e50;
      height: 100vh;
      padding: 20px;
      color: #ecf0f1;
    }
    .sidebar a {
      display: block;
      margin: 15px 0;
      text-decoration: none;
      color: #ecf0f1;
      font-weight: bold;
    }
    .sidebar a:hover {
      background: #34495e;
      padding: 8px;
      border-radius: 5px;
    }
    .content {
      margin-left: 240px;
      padding: 30px;
      background: #ffffffd0;
      border-radius: 10px;
      margin-top: 20px;
    }
    table, th, td {
      border: 1px solid #ddd;
      border-collapse: collapse;
      padding: 8px;
    }
    th {
      background-color: #2980b9;
      color: white;
    }
    input, select, textarea, button {
      width: 100%;
      margin-bottom: 10px;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 5px;
      box-sizing: border-box;
    }
    button {
      background-color: #2980b9;
      color: white;
      border: none;
      cursor: pointer;
    }
    button:hover {
      background-color: #3498db;
    }
  </style>
</head>
<body>

<div id="login-section" class="container">
  <h2>Login</h2>
  <form id="loginForm">
    <label>Email ID:</label>
    <input type="email" id="email" required />
    <label>Domain ID:</label>
    <input type="text" id="domainId" required />
    <label>Department:</label>
    <select id="department" required>
      <option value="Central">Central</option>
      <option value="NY/VA">NY/VA</option>
      <option value="East">East</option>
      <option value="West">West</option>
    </select>
    <button type="submit">Login</button>
  </form>
</div>

<div id="dashboard" class="hidden">
  <div class="sidebar">
    <h3>Dashboard</h3>
    <a href="#" onclick="showSection('doubt')">Doubt</a>
    <a href="#" onclick="showSection('resolved')">Resolved</a>
    <a href="#" onclick="showSection('mydoubt')">My Doubts</a>
    <a href="#" onclick="showSection('query')">Query to Answer</a>
  </div>
<div style="position: fixed; top: 10px; right: 20px; z-index: 999;">
  <button onclick="showPopupPage()" id="popupBtn">
  ðŸ”” Popup <span id="popupCount" style="background:red; color:white; padding:2px 6px; border-radius:12px; display:none;"></span>
</button>
  <button onclick="logout()">ðŸšª Logout</button>
</div>
  <div class="content">
    <h2 id="deptTitle"></h2>
    <div id="content-area"></div>
  </div>
</div>

<script>
let userEmail = '', userDomainId = '', userDepartment = '';
let popupMessages = [], unreadPopups = [], readPopups = [];

document.addEventListener('DOMContentLoaded', function () {
  const emailOptions = ['user1@example.com', 'user2@example.com'];
  const doughts = [], resolvedDoughts = [];

    const storedDoubts = localStorage.getItem('doubts');
    if (storedDoubts) doughts.push(...JSON.parse(storedDoubts));

    const storedResolved = localStorage.getItem('resolvedDoughts');
    if (storedResolved) resolvedDoughts.push(...JSON.parse(storedResolved));

    function saveDoubtsToStorage() {
      localStorage.setItem('doubts', JSON.stringify(doughts));
    }

    document.getElementById('loginForm').addEventListener('submit', function (e) {
      e.preventDefault();
      userEmail = document.getElementById('email').value;
      userDomainId = document.getElementById('domainId').value;
      userDepartment = document.getElementById('department').value;
      document.getElementById('deptTitle').innerText = userDepartment + ' Department Data';
      document.getElementById('login-section').classList.add('hidden');
      document.getElementById('dashboard').classList.remove('hidden');
      showSection('doubt');
let stored = JSON.parse(localStorage.getItem('popup_' + userDepartment)) || [];
unreadPopups = stored.filter(p => !p.read);
readPopups = stored.filter(p => p.read);
updatePopupBadge();

    });

    window.showSection = function (section) {
      let contentArea = document.getElementById('content-area');
      if (section === 'doubt') {
        contentArea.innerHTML = `
          <h3>Submit Doubt</h3>
          <label>Field:</label><select id='field'><option>Timely filling</option><option>General Inquiry</option><option>No Sccf</option><option>Pricing issue</option><option>High Dollar</option><option>Others</option></select>
          <label>Doubt Number:</label><input id='doubtNumber' required>
          <label>Attachment Number:</label><input id='attachmentNumber'>
          <label>Description:</label><textarea id='doubtDesc'></textarea>
          <label>Select Email:</label><select id='emailSelect'>${emailOptions.map(e => `<option>${e}</option>`).join('')}</select>
          <button onclick='submitDoubt()'>Submit</button>
        `;
      } else if (section === 'resolved') {
        contentArea.innerHTML = '<h3>Resolved Doubts</h3>' + generateResolvedTable();
      } else if (section === 'mydoubt') {
        const myDoubts = doughts.filter(d => d.domainId === userDomainId);
        let html = '<h3>My Doubts</h3>' + myDoubts.map(d =>
          `${d.doubtNumber} - ${d.status === 'resolved' ? 'Resolved: ' + d.resolvedComment : 'Under Review'} 
           <button onclick='viewDoubt("${d.doubtNumber}")'>View</button>`
        ).join('<br>');
        contentArea.innerHTML = html;
      } else if (section === 'query') {
        if (emailOptions.includes(userEmail)) {
          const assigned = doughts.filter(d => d.assignedEmail === userEmail && d.status === 'pending');
          contentArea.innerHTML = '<h3>Query to Answer</h3>' + assigned.map((d, index) => `
            <div style="border:1px solid #ccc; padding:10px; margin-bottom:10px;">
              <strong>${d.domainId}</strong> | Doubt No: ${d.doubtNumber}<br>
              Attachment No: ${d.attachmentNumber}<br>
              Description: ${d.description}<br>
              <button onclick="showResolveForm(${index})">Resolve</button>
              <div id="resolveForm${index}" style="display:none; margin-top:10px;">
                <label>Decision (max 15 words):</label><input id="decision${index}" maxlength="200">
                <label>Resolved Comment:</label><textarea id="comment${index}"></textarea>
                <label>Select Departments to Notify:</label>
<div class="checkbox-row" style="display: flex; flex-direction: row; gap: 15px; flex-wrap: wrap;">
  <label><input type="checkbox" name="dept${index}" value="Central"> Central</label>
  <label><input type="checkbox" name="dept${index}" value="NY/VA"> NY/VA</label>
  <label><input type="checkbox" name="dept${index}" value="East"> East</label>
  <label><input type="checkbox" name="dept${index}" value="West"> West</label>
</div>                <button onclick="resolveDoubt(${index})">Resolved</button>
                <button onclick="cancelResolve(${index})">Cancel</button>
              </div>
            </div>
          `).join('');
        } else {
          contentArea.innerHTML = '<h3>Access Denied</h3>';
        }
      }
    }

    window.submitDoubt = function () {
      const newDoubt = {
        field: document.getElementById('field').value,
        doubtNumber: document.getElementById('doubtNumber').value,
        attachmentNumber: document.getElementById('attachmentNumber').value,
        description: document.getElementById('doubtDesc').value,
        assignedEmail: document.getElementById('emailSelect').value,
        domainId: userDomainId,
        department: userDepartment,
        status: 'pending',
        resolvedComment: ''
      };
      doughts.push(newDoubt);
      saveDoubtsToStorage();
      alert('Doubt submitted successfully!');
      document.getElementById('field').value = 'Timely filling';
      document.getElementById('doubtNumber').value = '';
      document.getElementById('attachmentNumber').value = '';
      document.getElementById('doubtDesc').value = '';
      document.getElementById('emailSelect').selectedIndex = 0;
    }

    window.viewDoubt = function (doubtNumber) {
      const container = document.getElementById('content-area');
      const d = doughts.find(item => item.doubtNumber === doubtNumber);
      if (d) {
        container.innerHTML = `
          <h3>Doubt Detail</h3>
          <div style="border:1px solid #ccc; padding:15px; border-radius:10px;">
            <strong>Domain ID:</strong> ${d.domainId}<br>
            <strong>Doubt Number:</strong> ${d.doubtNumber}<br>
            <strong>Attachment Number:</strong> ${d.attachmentNumber}<br>
            <strong>Field:</strong> ${d.field}<br>
            <strong>Description:</strong> ${d.description}<br>
            <strong>Status:</strong> ${d.status}<br>
            ${d.status === 'resolved' ? `<strong>Resolved Comment:</strong> ${d.resolvedComment}<br>` : ''}
            <br><button onclick="showSection('mydoubt')">Back</button>
          </div>
        `;
      }
    }

    window.viewResolved = function(index) {
      const d = resolvedDoughts[index];
      const container = document.getElementById('content-area');
      container.innerHTML = `
        <h3>Resolved Doubt Detail</h3>
        <div style="border:1px solid #ccc; padding:15px; border-radius:10px;">
          <strong>Domain ID:</strong> ${d.domainId}<br>
          <strong>Doubt Number:</strong> ${d.doubtNumber}<br>
          <strong>Attachment Number:</strong> ${d.attachmentNumber}<br>
          <strong>Field:</strong> ${d.field || 'General'}<br>
          <strong>Description:</strong> ${d.description}<br>
          <strong>Resolved Comment:</strong> ${d.resolvedComment}<br><br>
          <button onclick="showSection('resolved')">Back</button>
        </div>
      `;
    }

window.filterResolvedTable = function() {
  const fieldFilter = document.getElementById('resolvedFilter').value.toLowerCase();
  const domainSearch = document.getElementById('searchDomainId').value.toLowerCase();
  const doubtSearch = document.getElementById('searchDoubtNo').value.toLowerCase();
  const descSearch = document.getElementById('searchDescription').value.toLowerCase();

  const rows = document.querySelectorAll('#resolvedTable tr[data-field]');
  rows.forEach(row => {
    const field = row.dataset.field?.toLowerCase() || '';
    const domain = row.children[1]?.innerText.toLowerCase() || '';
    const doubt = row.children[2]?.innerText.toLowerCase() || '';
    const description = row.children[4]?.innerText.toLowerCase() || '';

    const matches =
      (fieldFilter === 'all' || field === fieldFilter) &&
      domain.includes(domainSearch) &&
      doubt.includes(doubtSearch) &&
      description.includes(descSearch);

    row.style.display = matches ? '' : 'none';
  });
}


function generateResolvedTable() {
  let html = `
  <div style="display:flex; gap:10px; align-items:flex-end; flex-wrap:wrap; margin-bottom: 15px;">
    <div>
      <label>Field:</label>
      <select id="resolvedFilter" onchange="filterResolvedTable()">
        <option value="All">All</option>
        <option value="Timely filling">Timely filling</option>
        <option value="General Inquiry">General Inquiry</option>
        <option value="No Sccf">No Sccf</option>
        <option value="Pricing issue">Pricing issue</option>
        <option value="High Dollar">High Dollar</option>
        <option value="Others">Others</option>
      </select>
    </div>
    <div>
      <label>Domain ID:</label>
      <input type="text" id="searchDomainId" oninput="filterResolvedTable()" placeholder="Search...">
    </div>
    <div>
      <label>Doubt No:</label>
      <input type="text" id="searchDoubtNo" oninput="filterResolvedTable()" placeholder="Search...">
    </div>
    <div>
      <label>Description:</label>
      <input type="text" id="searchDescription" oninput="filterResolvedTable()" placeholder="Search...">
    </div>
  </div>
`;

  html += '<table id="resolvedTable"><tr><th>Field</th><th>Domain ID</th><th>Doubt No</th><th>Attachment No</th><th>Description</th><th>Resolved Comment</th><th>Action</th></tr>';
  for (const [index, d] of resolvedDoughts.entries()) {
    if (d.department.split(',').map(dep => dep.trim()).includes(userDepartment)) {
      html += `<tr data-field="${d.field || 'General'}">
        <td>${d.field || 'General'}</td><td>${d.domainId}</td><td>${d.doubtNumber}</td><td>${d.attachmentNumber}</td><td>${d.description}</td><td>${d.resolvedComment}</td>
        <td><button onclick="viewResolved(${index})">View</button></td></tr>`;
    }
  }
  html += '</table>';
  return html;
}

    window.showResolveForm = function(index) {
      document.getElementById('resolveForm' + index).style.display = 'block';
    }

    window.cancelResolve = function(index) {
      document.getElementById('resolveForm' + index).style.display = 'none';
    }

    window.resolveDoubt = function(index) {
      const doubt = doughts.filter(d => d.assignedEmail === userEmail && d.status === 'pending')[index];
      const decision = document.getElementById('decision' + index).value.trim();
      const comment = document.getElementById('comment' + index).value.trim();
      const depts = Array.from(document.querySelectorAll('input[name="dept' + index + '"]:checked')).map(cb => cb.value);

      if (!decision || decision.split(" ").length > 15 || !comment || depts.length === 0) {
        alert("Please fill all fields correctly (max 15 words for decision).");
        return;
      }

      doubt.status = 'resolved';
      doubt.resolvedComment = comment;
      doubt.department = depts.join(", ");
      saveDoubtsToStorage();

for (const dept of depts) {
  const msg = `Doubt No: ${doubt.doubtNumber}\\nField: ${doubt.field}\\nResolved Comment: ${comment}`;
let popupDept = JSON.parse(localStorage.getItem('popup_' + dept)) || [];
popupDept.push({ msg: msg, read: false });
localStorage.setItem('popup_' + dept, JSON.stringify(popupDept));

  resolvedDoughts.push({
    domainId: doubt.domainId,
    doubtNumber: doubt.doubtNumber,
    attachmentNumber: doubt.attachmentNumber,
    description: doubt.description,
    resolvedComment: comment,
    department: dept,
    field: doubt.field
  });
}
      localStorage.setItem('resolvedDoughts', JSON.stringify(resolvedDoughts));

      alert("Email sent to: " + doubt.domainId + "\\nResolved in departments: " + depts.join(", "));
      alert("Popup to users in departments: " + depts.join(", "));

      showSection('query');
    }
  });

window.showPopup = function() {
  if (popupMessages.length === 0) {
    alert("No new popups.");
  } else {
    alert("Notifications:\\n\\n" + popupMessages.join("\\n\\n"));
    popupMessages = [];
  }
}

window.logout = function() {
  location.reload(); // resets and returns to login screen
}
function updatePopupBadge() {
  const badge = document.getElementById("popupCount");
  if (!badge) return;
  badge.textContent = unreadPopups.length;
  badge.style.display = unreadPopups.length > 0 ? 'inline-block' : 'none';
}

function showPopupPage() {
  const container = document.getElementById('content-area');
  let html = "<h3>ðŸ“¬ Department Notifications</h3>";

  if (unreadPopups.length === 0 && readPopups.length === 0) {
    html += "<p>No notifications yet.</p>";
  } else {
    html += "<ul>";
    unreadPopups.forEach((p, i) => {
      html += `<li style="color:darkred">
        <strong>Unread:</strong> ${p.msg.split('\\n')[0]}
        <button onclick="viewPopupDetail('unread', ${i})">View</button>
      </li>`;
    });
    readPopups.forEach((p, i) => {
      html += `<li style="color:gray">
        <strong>Read:</strong> ${p.msg.split('\\n')[0]}
        <button onclick="viewPopupDetail('read', ${i})">View</button>
      </li>`;
    });
    html += "</ul>";
  }

  html += `<br><button onclick="markAllRead()">Mark All Read</button>`;
  container.innerHTML = html;
}

function markAllRead() {
  unreadPopups.forEach(p => p.read = true);
  readPopups.push(...unreadPopups);
  unreadPopups = [];
  localStorage.setItem('popup_' + userDepartment, JSON.stringify([...readPopups]));
  updatePopupBadge();
  showPopupPage();
}

function viewPopupDetail(type, index) {
  const popup = (type === 'unread') ? unreadPopups[index] : readPopups[index];
  const container = document.getElementById('content-area');

  container.innerHTML = `
    <h3>ðŸ“„ Notification Details</h3>
    <div style="border:1px solid #ccc; padding:15px; border-radius:10px;">
      <pre>${popup.msg}</pre>
      <br>
      <button onclick="showPopupPage()">Back to Notifications</button>
    </div>
  `;
}

</script>

</body>
</html>
